#!/bin/sh

checkDrun() {
	runPacks=("wofi" "dmenu")
	shell=("zsh" "bash")
	profile=("\$HOME\/.config\/shell\/profile" "\$HOME\/.bash_profile")
	export myrun="dmenu"
	export myshell="zsh"
	export myprofile="$HOME/.config/shell/profile"
	if [[ ${myrun} == "" || ${myshell} == "" || ${myprofile} == "" ]]; then
		for x in "${runPacks[@]}"; do
			which ${x} >/dev/null
			if (( $? == 0 )); then
				sed -i "0,/export myrun=\"\"/s//export myrun=\"${x}\"/" $(find ~ -name "myencpas")
			fi
		done
		for y in "${shell[@]}"; do
			shellChoice=$(echo $SHELL | awk '{split($0,i,"/"); print i[4];}')
			if [[ "${shellChoice}" == ${y} ]]; then
				sed -i "0,/export myshell=\"\"/s//export myshell=\"${y}\"/" $(find ~ -name "myencpas")
			fi
		done
		if [[ "${shellChoice}" == "zsh" ]]; then
			sed -i "0,/export myprofile=\"\"/s//export myprofile=\"${profile[0]}\"/" $(find ~ -name "myencpas")
		elif [[ "${shellChoice}" == "bash" ]]; then
			sed -i "0,/export myprofile=\"\"/s//export myprofile=\"${profile[1]}\"/" $(find ~ -name "myencpas")
		fi

	fi
}

setDrun() {
	if [[ "${myrun}" == "wofi" ]]; then
		myMenu="wofi -d -i -w 10 -l bottom -W 1000 -H 100"
		myCBCpy="wl-copy"
		myCBClr="wl-copy -c"
	elif [[ "${myrun}" == "dmenu" ]]; then
		myMenu="dmenu -b -i"
		myCBCpy="xclip -selection clipboard"
		myCBClr="xsel -bc"
	fi
}

crptF() {
	if [[ $1 == encrypt && $3 == pass ]]; then
		gpg --batch --passphrase $4 --cipher-algo AES256 -c $2
	elif [[ $1 == encrypt ]]; then
		encpas=$(printf "enter encryption passphrase" | ${myMenu} -p "encryption passphrase" -P)
		gpg --batch --passphrase $encpas --cipher-algo AES256 -c $2
	elif [[ $1 == decrypt ]]; then
		encpas=$(printf "enter decryption passphrase" | ${myMenu} -p "decryption passphrase" -P)
		gpg --batch --passphrase $encpas -d $2 1>/dev/null 2>/dev/null
		if (( $? == 0 )); then
			gpg --batch --passphrase $encpas -d $2 > $3
		else
			notify-send "âŒ Wrong Pasword." &&
			exit 0
		fi
	fi
}

savediS() {
	saveme(){
		notiA
		sort -o tmppas{,} &&
		gpg --batch --passphrase $encpas --cipher-algo AES256 -c tmppas &&
		rm pass.txt tmppas && mv tmppas.gpg pass.txt
	}
	discardme(){
		sed -i '$d' tmppas &&
		notiD
		gpg --batch --passphrase $encpas --cipher-algo AES256 -c tmppas &&
		rm pass.txt tmppas && mv tmppas.gpg pass.txt
	}
	case $1 in
		save)saveme;;
		discard)discardme;;
		*)
			saveorD=$(printf "save\ndiscard" | ${myMenu} -p "save or discard changes?") &&
			if [[ "$saveorD" == "discard" ]]; then
				discardme
			else
				saveme
			fi
			;;
	esac
}

initP() {
	clear &&
	toilet -w 160 -F border --gay "INITIALIZING MYPAS"

	printf "\n\nEnter a passphrase: " && read -s newencpas && printf "\n"

	printf "\n%s" "Making necessary directory, file and encrypting."
	mkdir $HOME/Documents/pas && cd $HOME/Documents/pas && printf "%s\t%s\n" "username" "password" > pass.txt && crptF encrypt pass.txt pass $newencpas && rm pass.txt && mv pass.txt.gpg pass.txt && sleep 1 &&
	printf "\t\033[32;1;2m%s\033[0m\n" "[OK]"

	printf "\n%s" "Making a .scripts directory and adding it to path."
	mkdir -p $HOME/.scripts && cp $(find ~ -name "myencpas") $HOME/.scripts && printf "\n%s\n" "export PATH=\$HOME/.scripts:\$PATH" >> $myprofile && sleep 1 &&
	printf "\t\033[32;1;2m%s\033[0m\n" "[OK]"

	printf "\n%s\n" "Run \"myencpas\" from anywhere or add it your key-bind."
}

getornew() {
	checkDrun &&
	choice=$(printf "get\nnew\ngenerate\nedit" | ${myMenu} -p "mypas.") &&
	case $choice in
		get) getP;;
		new) newP;;
		generate) gennewP;;
		edit) editP;;
	esac
}

getP() {
	ls tmppas 1>/dev/null 2>/dev/null
	if (( $? != 0 )); then
		crptF decrypt pass.txt tmppas
	fi
	usrname=$(printf "" | cat tmppas | awk '{split($0,i,"\t"); print i[1];}' | ${myMenu} -p "which pasword?") &&
	awk -F"\t" -v pat="$usrname" '$1 ~ "^" pat "$" {print $2}' tmppas | ${myCBCpy} &&
	notiCo && sleep 30 && ${myCBClr}; rm tmppas; notiCl
}

newP() {
	ls tmppas 1>/dev/null 2>/dev/null
	if (( $? != 0 )); then
		crptF decrypt pass.txt tmppas
	fi
	newpa=$(printf "enter username<SPACE>password" | ${myMenu} -p "eg.(username<SPACE>password)") &&
	printf "%s\t%s\n" $newpa >> tmppas &&
	savediS
}

gennewP() {
	charlen=$(printf "enter the length" | ${myMenu} -p "eg(16)") &&
	randpas=$(tr -dc '[:graph:]' </dev/urandom | head -c ${charlen}) &&
	printf "%s" $randpas | ${myCBCpy} &&
	choice=$(printf "save\nno" | ${myMenu} -p "save the generated pasword?")
	case $choice in
		save)
			usrn_newp=$(printf "give a username for generated pasword" | ${myMenu} -p "username/email_id for the generated pasword? eg(username)") &&
			crptF decrypt pass.txt tmppas
			printf "%s\t%s\n" $usrn_newp $randpas >> tmppas &&
			savediS save
			;;
		no)
			sleep 60 &&
			${myCBClr}
			exit 0
			;;
	esac
}

editP() {
	crptF decrypt pass.txt tmppas &&
	$TERMINAL -e $EDITOR tmppas
	crptF encrypt tmppas pass $encpas && rm tmppas && mv tmppas.gpg pass.txt
}

notiA() {
	notify-send "ðŸ¤© pasword added!"
}

notiD() {
	notify-send "ðŸ˜¥ pasword discarded"
}

notiCo() {
	notify-send "ðŸ˜€ pasword copied to clipboard!"
}

notiCl() {
	notify-send "ðŸ˜¥ pasword cleared!"
}

mainP(){
	cd $HOME/Documents/pas 2>/dev/null
	if (( $? != 0 )); then
		printf "%s\n" "Could not find the required directory, run the script with -i, to initialize."
		notify-send "Could not find the required directory, run the script with -i, to initialize."
		exit
	else
		checkDrun &&
		setDrun &&
		getornew &&
		exit
	fi
}

while getopts "i" OPTION
do
	case $OPTION in
		i)
			checkDrun &&
			if [[ "${myrun}" == "" || "${myshell}" == "" || "${myprofile}" == "" ]]; then
				./$(basename $0) -i && exit
			fi
			sleep 1 &&
			setDrun &&
			initP &&
			exit
			;;
	esac
done

mainP
